<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">เว็ป/แอปคำนวณต้นทุน</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#4CAF50">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').then(reg => reg.update());
      });
    }
  </script>

  <style>
    body {font-family:'Segoe UI',sans-serif;margin:0;padding:20px;display:flex;justify-content:center;background:linear-gradient(to bottom right,#f0f4f8,#d9e2ec);color:#000;transition:0.4s;}
    body.dark{background:linear-gradient(to bottom right,#1e1e1e,#2c2c2c);color:#fff;}
    .container{width:95%;max-width:720px;background:#fff;padding:25px 30px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.12);}
    body.dark .container{background:#2a2a2a;box-shadow:0 10px 30px rgba(0,0,0,0.6);}
    h2{text-align:center;margin-top:0;}
    .language-select{text-align:right;margin-bottom:15px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
    details{margin:15px 0;border-radius:12px;padding:12px;background:#f9fafc;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
    body.dark details{background:#333;color:#fff;}
    details summary{font-weight:600;font-size:16px;cursor:pointer;outline:none;}
    .input-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;align-items:center;}
    .input-row input,.input-row select{flex:1;padding:10px 12px;border:1px solid #ccd6dd;border-radius:10px;font-size:14px;background:#fff;}
    body.dark .input-row input,body.dark .input-row select{background:#444;color:#fff;border-color:#666;}
    button{padding:10px 18px;margin:5px 5px 5px 0;cursor:pointer;border:none;border-radius:12px;background:#4CAF50;color:white;font-weight:600;font-size:15px;}
    button:hover{background:#45a049;}
    button.delete{background:#e74c3c;}
    button.delete:hover{background:#c0392b;}
    #result{margin-top:20px;padding:20px;border-radius:16px;background:#e8f5e9;border:1px solid #a5d6a7;font-weight:500;line-height:1.9;}
    body.dark #result{background:#3a3a3a;border:1px solid #666;color:#fff;}
    #versionPanel{position:fixed;bottom:10px;left:10px;padding:6px 10px;background:rgba(0,0,0,0.7);color:#fff;font-size:11px;border-radius:6px;z-index:9999;}
  </style>
</head>
<body>
  <div class="container">
    <div class="language-select">
      <select id="langSelect" onchange="switchLang()">
        <option value="th">ไทย</option>
        <option value="en">English</option>
      </select>
      <button id="themeBtn" onclick="toggleDarkMode()">Dark Mode</button>
    </div>
    <h2 id="title">เว็ป/แอปคำนวณต้นทุน</h2>

    <details open>
      <summary id="labelMaterial">วัตถุดิบ</summary>
      <div id="materials"></div>
      <button onclick="addMaterial()" id="addBtn">+ เพิ่มวัตถุดิบ</button>
    </details>

    <details>
      <summary id="labelLabor">ค่าแรง & ค่าใช้จ่าย</summary>
      <div class="input-row">
        <input type="number" id="workers" placeholder="จำนวนคน">
        <input type="number" id="wage" placeholder="ค่าแรงต่อคน">
      </div>
      <div class="input-row">
        <input type="number" id="water" placeholder="ค่าน้ำ">
        <input type="number" id="electricity" placeholder="ค่าไฟ">
      </div>
    </details>

    <div style="margin-top:15px;">
      <button onclick="calculate()" id="calcBtn">คำนวณ</button>
      <button onclick="resetAll()" id="resetBtn">รีเซ็ต</button>
    </div>

    <div id="result"></div>
  </div>

  <div id="versionPanel">V2.0</div>

  <script>
    let materialCount = 0;
    const texts = {
      th: {
        title: "เว็ป/แอปคำนวณต้นทุน",
        materials: "วัตถุดิบ", laborSection: "ค่าแรง & ค่าใช้จ่าย",
        workers: "จำนวนคน", wage: "ค่าแรง/คน", water: "ค่าน้ำ", electricity: "ค่าไฟ",
        matName: "ชื่อวัตถุดิบ", matQty: "จำนวน (เช่น 2 จาน)", matCost: "ราคาต่อหน่วย", matProfit: "กำไร/หน่วย",
        addMaterial: "+ เพิ่มวัตถุดิบ", deleteBtn: "ลบ",
        labor: "ค่าแรงรวม", other: "ค่าน้ำ + ค่าไฟ", material: "วัตถุดิบรวม",
        total: "ต้นทุนรวม", profitText: "กำไรรวม", sale: "ราคาขายรวม",
        calc: "คำนวณ", reset: "รีเซ็ต",
        darkMode: "โหมดมืด", lightMode: "โหมดสว่าง",
        symbol: "฿", symbolBefore: false,
        empty: "กรุณาใส่ข้อมูลเพื่อคำนวณ"
      },
      en: {
        title: "Cost Calculator",
        materials: "Materials", laborSection: "Labor & Expenses",
        workers: "Workers", wage: "Wage/person", water: "Water bill", electricity: "Electricity bill",
        matName: "Material name", matQty: "Qty (e.g. 2 pcs)", matCost: "Cost/unit", matProfit: "Profit/unit",
        addMaterial: "+ Add material", deleteBtn: "Delete",
        labor: "Total labor cost", other: "Water + Electricity", material: "Total materials",
        total: "Total cost", profitText: "Total profit", sale: "Selling price",
        calc: "Calculate", reset: "Reset",
        darkMode: "Dark Mode", lightMode: "Light Mode",
        symbol: "$", symbolBefore: true,
        empty: "Please enter data to calculate"
      }
    };

    function formatMoney(amount) {
      const lang = document.getElementById("langSelect").value;
      const t = texts[lang];
      const num = Number(amount).toLocaleString("en-US", {minimumFractionDigits: 0, maximumFractionDigits: 2});
      return t.symbolBefore ? `${t.symbol}${num}` : `${num} ${t.symbol}`;
    }

    function switchLang() {
      const lang = document.getElementById("langSelect").value;
      const t = texts[lang];
      localStorage.setItem("lang", lang);
      document.getElementById("title").textContent = t.title;
      document.getElementById("pageTitle").textContent = t.title;
      document.getElementById("labelMaterial").textContent = t.materials;
      document.getElementById("labelLabor").textContent = t.laborSection;
      document.getElementById("addBtn").textContent = t.addMaterial;
      document.getElementById("calcBtn").textContent = t.calc;
      document.getElementById("resetBtn").textContent = t.reset;
      document.getElementById("themeBtn").textContent = document.body.classList.contains("dark") ? t.lightMode : t.darkMode;
      document.getElementById("workers").placeholder = t.workers;
      document.getElementById("wage").placeholder = t.wage;
      document.getElementById("water").placeholder = t.water;
      document.getElementById("electricity").placeholder = t.electricity;
      document.querySelectorAll("#materials .input-row").forEach(row => {
        row.children[0].placeholder = t.matName;
        row.children[1].placeholder = t.matQty;
        row.children[2].placeholder = t.matCost;
        row.children[3].placeholder = t.matProfit;
        if (row.children[4]) row.children[4].textContent = t.deleteBtn;
      });
    }

    function addMaterial(name="", qty="", cost="", profit="") {
      materialCount++;
      const t = texts[document.getElementById("langSelect").value];
      const div = document.createElement("div");
      div.className = "input-row";
      div.id = "material-" + materialCount;
      div.innerHTML = `
        <input type="text" placeholder="${t.matName}" value="${name}" style="flex:2">
        <input type="text" placeholder="${t.matQty}" value="${qty}">
        <input type="number" placeholder="${t.matCost}" value="${cost}">
        <input type="number" placeholder="${t.matProfit}" value="${profit}">
        <button class="delete" onclick="deleteMaterial(${materialCount})">${t.deleteBtn}</button>
      `;
      document.getElementById("materials").appendChild(div);
    }

    function deleteMaterial(id) {
      document.getElementById("material-" + id)?.remove();
      saveData();
    }

    function calculate() {
      const lang = document.getElementById("langSelect").value;
      const t = texts[lang];

      const workers = parseFloat(document.getElementById("workers").value) || 0;
      const wage = parseFloat(document.getElementById("wage").value) || 0;
      const water = parseFloat(document.getElementById("water").value) || 0;
      const electricity = parseFloat(document.getElementById("electricity").value) || 0;

      let materialCost = 0;
      let profitTotal = 0;
      let hasMaterials = false;

      document.querySelectorAll("#materials .input-row").forEach(row => {
        const qtyStr = row.children[1].value.trim();
        const cost = parseFloat(row.children[2].value) || 0;
        const profit = parseFloat(row.children[3].value) || 0;
        if (cost > 0 || profit > 0 || qtyStr) hasMaterials = true;
        let qty = parseFloat(qtyStr) || 1;
        if (isNaN(qty) && qtyStr) { const m = qtyStr.match(/[\d.]+/); qty = m ? parseFloat(m[0]) : 1; }
        materialCost += qty * cost;
        profitTotal += qty * profit;
      });

      const laborCost = workers * wage;
      const otherCost = water + electricity;
      const totalCost = laborCost + otherCost + materialCost;
      const sellingPrice = totalCost + profitTotal;

      // ตรวจสอบว่ามีข้อมูลอะไรบ้าง
      let lines = [];

      if (laborCost > 0) lines.push(`${t.labor}: <strong>${formatMoney(laborCost)}</strong>`);
      if (otherCost > 0) lines.push(`${t.other}: <strong>${formatMoney(otherCost)}</strong>`);
      if (materialCost > 0 || hasMaterials) lines.push(`${t.material}: <strong>${formatMoney(materialCost)}</strong>`);
      if (lines.length > 0) lines.push(`${t.total}: <strong>${formatMoney(totalCost)}</strong>`);
      if (profitTotal > 0) lines.push(`<br>${t.profitText}: <strong>${formatMoney(profitTotal)}</strong>`);

      const resultHTML = lines.length > 0
        ? lines.join("<br>") + `<br><br><strong style="font-size:1.4em;color:#4CAF50;">${t.sale}: ${formatMoney(sellingPrice)}</strong>`
        : `<span style="color:#999;">${t.empty}</span>`;

      document.getElementById("result").innerHTML = resultHTML;
      saveData();
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      const t = texts[document.getElementById("langSelect").value];
      document.getElementById("themeBtn").textContent = isDark ? t.lightMode : t.darkMode;
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    function saveData() {
      const data = {
        lang: document.getElementById("langSelect").value,
        workers: document.getElementById("workers").value || "",
        wage: document.getElementById("wage").value || "",
        water: document.getElementById("water").value || "",
        electricity: document.getElementById("electricity").value || "",
        materials: []
      };
      document.querySelectorAll("#materials .input-row").forEach(row => {
        data.materials.push({
          name: row.children[0].value,
          qty: row.children[1].value,
          cost: row.children[2].value,
          profit: row.children[3].value
        });
      });
      localStorage.setItem("calcData", JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem("calcData");
      if (!saved) return;
      const data = JSON.parse(saved);
      if (data.lang) document.getElementById("langSelect").value = data.lang;
      switchLang();
      document.getElementById("workers").value = data.workers || "";
      document.getElementById("wage").value = data.wage || "";
      document.getElementById("water").value = data.water || "";
      document.getElementById("electricity").value = data.electricity || "";
      document.getElementById("materials").innerHTML = "";
      (data.materials || []).forEach(m => addMaterial(m.name, m.qty, m.cost, m.profit));
      if (!data.materials || data.materials.length === 0) addMaterial();
    }

    function resetAll() {
      if (confirm("ลบข้อมูลทั้งหมดหรือไม่? / Clear all data?")) {
        localStorage.removeItem("calcData");
        location.reload();
      }
    }

    window.onload = () => {
      const savedLang = localStorage.getItem("lang") || "th";
      document.getElementById("langSelect").value = savedLang;
      if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark");
      switchLang();
      loadData();
    };
  </script>
</body>
</html>
